name: Push to master

on:
  push:
    branches:
      - master

  workflow_dispatch:

jobs:
  build-image:
    uses: ./.github/workflows/_build-backend.yml
    with:
      publish: true
    secrets:
      AWS_ECR_IMAGE_PUBLISHER_ROLE_ARN: ${{ secrets.AWS_ECR_IMAGE_PUBLISHER_ROLE_ARN }}
    permissions:
      id-token: write
      contents: read

  deploy-backend:
    needs: build-image
    uses: ./.github/workflows/_deploy-backend.yml

  deploy-frontend:
    uses: ./.github/workflows/_deploy-frontend.yml
    secrets:
      AWS_CDK_DEPLOY_ROLE_ARN: ${{ secrets.AWS_CDK_DEPLOY_ROLE_ARN }}
    permissions:
      id-token: write
      contents: read
